# 结构化异常检测方法

## 目标
- 通过一组可重复的规则，识别财务报表中的结构性异常（波动异常、成本/费用率反常、资产负债错配等），为后续人工复核或风控预警提供线索。

## 适用范围
- 资产负债表、利润表、现金流量表的多期数据（建议不少于 4 期）。
- 单公司纵向趋势分析；若有行业基准，可叠加横向对比。

## 异常规则库
### A. 连续波动异常
- 监测指标：营业收入、净利润、经营活动现金流净额、毛利率。
- 单期增速 = (本期值 - 上期值) / 上期值；波动幅度 = |本期增速 - 上期增速|。
- 触发条件：
  - 同向高速：|本期增速| > 30% 且 |上期增速| > 30% 且符号相同。
  - 反转剧震：本期增速 < -20% 且 上期增速 > 20% 且 波动幅度 > 40 个百分点。

### B. 成本/费用率反常
- 成本率 = 营业成本 / 营业收入。
- 三费率 = (销售费用 + 管理费用 + 财务费用) / 营业收入。
- 研发费用率 = 研发费用 / 营业收入。
- 判定：任一费用率较近 4 期中位数偏离 > 15 个百分点，或落在历史 IQR 上下界之外 1.5 倍。

### C. 资产负债错配
- 流动缺口 = 货币资金 + 交易性金融资产 - (短期借款 + 一年内到期的非流动负债)。
- 短期债务占比 = (短期借款 + 一年内到期的非流动负债) / 总负债。
- 长期资产占比 = (固定资产 + 在建工程 + 投资性房地产) / 总资产。
- 触发条件（满足其一即异常）：
  - 流动比率 < 1 且 流动缺口 < 0。
  - 短期债务占比 > 70% 且 长期资产占比 > 50%，提示“短贷长投”风险。

### D. 现金流与利润背离
- 经营现金流/净利润 < 0.8 连续两期，或
- 净利润为正但经营现金流为负连续两期。

### E. 应收/存货异常
- 应收周转率 = 营业收入 / 平均应收账款；周转天数 = 365 / 应收周转率。
- 存货周转率 = 营业成本 / 平均存货；周转天数 = 365 / 存货周转率。
- 触发条件：
  - 应收或存货周转天数同比上升 > 30 天且同期营收增速 < 10%。
  - 应收/营收或存货/营收较近 4 期均值偏离 > 15 个百分点。

### F. 资本开支/费用资本化异常
- 资本开支率 = (固定资产、在建工程等非流动资产的增量 + 购建长期资产支付的现金) / 营业收入。
- 异常：资本开支率单期 > 30% 且 较近 4 期均值提升 > 15 个百分点；或资本开支快速上升同时研发费用率下降 > 10 个百分点（可能存在费用资本化倾向）。

## 计算规则
- 平均值采用 (期初 + 期末) / 2；同比按可对齐的同期口径计算。
- 若分母为 0，输出为空或标记“不可计算”；缺失值不参与分位数/IQR 计算。
- 建议保留 2 位小数，百分比类指标输出为百分比格式。
- 默认使用最近 N 期（推荐 4~8 期）计算基准均值、中位数与 IQR；N 由函数入参控制。

## 输出形式
- 输出内容：markdown 报告 + 可视化图片。
- markdown 规范：在报告开头加入提示
  - `prompt：请在适当的位置插入图片，严格遵守markdown图片的插入规范，图片内容如下：图片1...`，图片名称需与生成的可视化文件一致。
- 建议可视化：
  - 波动异常：关键指标增速折线/柱状。
  - 费用率反常：费用率与历史中位数/IQR 的箱线或带状图。
  - 资产负债错配：流动缺口、短债占比与长期资产占比的组合条形图。

## 建议实现方式
1. 新增模块：`src/report_data_struct_anomaly.py`。
2. 数据读取：复用 `report_data_reader`。
3. 规则实现：将每条规则封装为函数，返回 bool（是否异常）+ 置信度/严重度评分；用字典统一管理。
4. 可视化：使用 matplotlib/seaborn 生成折线、柱状、箱线图，文件名与 markdown 提示保持一致。
5. 输出目录：`stock_report_data/{code}/struct_anomaly`。

## 字段对照（基于 `表头.txt`）
- 利润表：`Operating Revenue`、`Operating Costs`、`Net Profit`（或 `Net Profit Attributable to Parent`）、`Selling Expenses`、`Administrative Expenses`、`Financial Expenses`、`R&D Expenses`。
- 资产负债表：`Cash and Cash Equivalents`、`Trading Financial Assets`、`Notes and Accounts Receivable`（或 `Accounts Receivable`）、`Inventories`、`Total Assets`、`Fixed Assets`、`Construction in Progress`、`Investment Property`、`Current Liabilities`、`Short-term Borrowings`、`Non-current Liabilities Due within One Year`、`Total Liabilities`。
- 现金流量表：`Net Cash Flow from Operating Activities`、`Cash Paid for Acquisition of Fixed Assets, Intangible Assets, and Other Long-term Assets`（资本开支）。

## 调用规范
`struct_anomaly_analysis(symbol, number)`
- `symbol`：股票代码。
- `number`：分析期数，按时间顺序取最近 `number` 期数据作为样本窗口。

## 注意事项
- 报告需注明数据频率（年报/季报），避免跨频率直接比较。
- 若行业基准可用，应标明样本范围、时间与分位数口径。
- 阈值可按行业微调；默认阈值在代码中集中配置，便于后续校准。
- 出现极端异常时需在报告文本中给出简单解释（如分母过小、一次性损益、会计政策变更）。 
